export const meta = {
  title: 'Nginx ä¸­ä½¿ç”¨ Lua åŠ¨æ€é…ç½®',
  keywords: 'nginx, lua, dynamic route',
  description: 'nginxä¸­ä½¿ç”¨luaåŠ¨æ€é…ç½®å„äº§å“è·¯ç”±',
  date: '2023-12-20',
  tags: ['nginx', 'lua'],
  summary: 'æœ‹å‹å…¬å¸æ¸…é€€æ‰€æœ‰äººå‘˜, å½“åˆå†—ä½™çš„å‰ç«¯æœºå­éœ€è¦è¿›è¡Œæ•´åˆ, æ¶‰åŠåˆ°ä»€ä¹ˆå‘¢? ç‚¹è¿›æ¥çœ‹çœ‹å§~',
}

import PostLayout from 'components/post-layout'
import Img from 'components/mdx/img'

<Img
  src="/weibo/large/6708d6c2gy1hl04no2c7ej210c0ie7vy.jpg"
  alt="nginx proxy"
  width={1308}
  height={662}
/>

### ä¸šåŠ¡èƒŒæ™¯

ä¸šåŠ¡æ˜¯ SaaS äº§å“, ç«™ç‚¹æ ‡è¯†æ ¼å¼ä¸º: `uid.(p.domain){n}.com`, å®¢æˆ·å¯è‡ªç”±ç»‘å®šåŸŸååˆ°è‡ªå·±ç«™ç‚¹. 
ç”±äºå›½å†…ç‰¹æ®ŠåŸå› , éœ€æœ‰å¢ƒå¤–/å¢ƒå†…åˆ†åˆ«é…ç½®, æ‰€ä»¥æ•°æ®åº“ä½¿ç”¨ redis åªè¯»å®ä¾‹æ”¾åœ¨å¯¹åº”ä»£ç†æœº.


åˆæœŸè€ƒè™‘è¢«æ”»å‡»æƒ…å†µ, æ‰€ä»¥æ¯ä¸ªäº§å“åˆ†åˆ«æœ‰å¢ƒå†…/å¢ƒå¤–ä»£ç†æœº. å½“å¢ƒå†…è¢«æ”»å‡»æ—¶, ç”± DNSPod æ£€æµ‹æŸè·¯å¾„æ˜¯å¦å¯ç”¨è€Œåˆ‡æ¢åˆ°å¢ƒå¤–ä»£ç†æœº.

å•ç‹¬äº§å“éƒ¨ç½²æ—¶, åŸç†å¾ˆç®€å•, åªéœ€è¦è·å– redis ä¸­ Hashæ•°æ® `äº§å“æ ‡è¯†:ç»‘å®šåŸŸå`-`uid`, è·å– `uid` ä¹‹å, æ‹¼æ¥å¯¹åº”äº§å“åç¼€, å¦‚ `uid.p1.domain.com`, è®¾ç½®åˆ° `proxy header` å³å¯

> ä¾‹å¦‚: www.example.com -> uid.p1.domain.com -> ä¸šåŠ¡æœº, redis ä¸­ hash key: p1:www.example.com

```lua
ngx.var.realhost = uid .. domainAffix
```
```bash
proxy_set_header Host $realhost;
```

ä½†ç”±äºç°ç¯å¢ƒåŸå› , éœ€è¦æŠŠæ‰€æœ‰äº§å“åªä¿ç•™ä¸€ä¸ªå¢ƒå†…/å¢ƒå¤–ä»£ç†æœº, è¿™éœ€è¦è€ƒè™‘ä¸åŒäº§å“çš„`æ ‡è¯†åç¼€`, `æ—¥å¿—Index`ç­‰.

### å¼€å§‹æ•´åˆ

é¦–å…ˆéœ€è¦è·å–åˆ°åŸŸåå¯¹åº”ç»‘å®šçš„å¹³å°, æŒ‰ç…§æµé‡å¤§å°æ’äº†ä¸ªåº, æ”¾åœ¨ `config.platforms` ä¸­
```lua
platforms = {'p1', 'p2', 'p3'}
-- å½“åˆæƒ³ç›´æ¥ä½¿ç”¨ platformAffix çš„ key, ç»“æœ lua çš„ pair å‡ºæ¥çš„é¡ºåºæ˜¯ä¸å›ºå®šçš„, å°±æ”¾å¼ƒäº†
platformAffix = {
  p1 = '.p1.domain.com',
  p2 = '.p2.domain.com',
  p3 = '.p3.domain.com'
}
```

ä¸‹é¢è·å–å¯¹åº”å¹³å°, ä½¿ç”¨ host å‚æ•°è€Œä¸ç›´æ¥ä½¿ç”¨ ngx.var.host, æ˜¯å› ä¸º ssl é˜¶æ®µæ— æ³•è·å– host, è€Œæ˜¯ client_hello ä¸­çš„ server_name, è¿™æ ·å°±å¯ä»¥å¤ç”¨å‡½æ•°

```lua
function getRecordPlatform(host)
  -- nginx.conf ä¸­å®šä¹‰çš„ `lua_shared_dict platformCache 10m` ç¼“å­˜
  -- é¿å…é¢‘ç¹æŸ¥è¯¢ redis
  local platformCache = ngx.shared.platformCache

  local platform = platformCache:get(host)

  if platform then
    return platform
  end

  local red = redis:new(config.redis)

  -- é¿å…åœ¨ lua for loop æäº¤è¯·æ±‚åˆ° redis
  -- ç›´æ¥ä½¿ç”¨ redis script æŸ¥è¯¢å®Œè¿”æ¥.
  local res, err = red:eval([[
    for i=1,#ARGV do 
      local platform = ARGV[i]
      local host = KEYS[1]
      local res, err = redis.call('exists', platform .. ':' .. host)

      if res == 1 then
        return platform
      end
    end

    return nil
  ]], 1, host, table.unpack(config.platforms))

  if not res then
    ngx.log(ngx.ERR, 'get record platform failed: ', err)
    ngx.exit(ngx.HTTP_FORBIDDEN)
  end

  -- set cache, expire after one day
  platformCache:set(host, res, 60 * 60 * 24)
  return res
  
end
```

æŸ¥è¯¢åŸŸåç»‘å®šçš„å¯¹åº”äº§å“å, å†è·å– `uid/cert pem/cert key`, ä½¿ç”¨ `uid` è®¾ç½® Host, ä½¿ç”¨ `cert pem/cert key` è°ƒç”¨ `ssl_certificate_by_lua_file` è®¾ç½®è¯ä¹¦
```lua
-- getUID ä¸­ è°ƒç”¨ getRecordPlatform è·å– platform å¹¶è®¾ç½® ngx.var
local uid = getUID(host)

if uid then
  ngx.var.realhost = uid .. config.platformAffix[ngx.var.platform]
  ngx.var.uid = uid
end

```
è‡³æ­¤, éœ€è¦çš„å˜é‡éƒ½å·²ç»è·å–å®Œæ¯•, åœ¨ nginx é…ç½® `rewrite_by_lua_file xxxxx.lua` å³å¯ä½¿ç”¨è®¾ç½®çš„å˜é‡, è€Œä¸ºä»€ä¹ˆè¦æ”¾åœ¨ rewrite? çœ‹çœ‹ [Nginx Phases](https://nginx.org/en/docs/dev/development_guide.html#http_phases) å§

<Img
  src="/weibo/large/6708d6c2gy1hl07yt548cj20rx0pagqs.jpg"
  alt="nginx lua directives"
  width={1005}
  height={910}
/>

### æ—¥å¿—

ç”±äºä»¥å‰éƒ½æ˜¯ç¡¬ç¼–ç åˆ° `access_log`, å¦‚:
```text
log_format es_log '$remote_addr || $http_host || $request_uri || $http_referer || $http_user_agent || $upstream_response_time || $status

map $status $log2es {
  ~^[23]  1;
  default 0;
}

map $status $log2file {
  ~^[23]  0;
  default 1;
}

# æˆåŠŸçš„è¯·æ±‚æ‰å»æ—¥å¿—æœåŠ¡å™¨ (æ ¹æ®å¯¹åº”tagåˆ’åˆ†)
# å¤±è´¥çš„è¯·æ±‚ä¿ç•™åœ¨æœ¬æœº, é…åˆ fail2ban å°IP
access_log syslog:server=es-server,tag=p(n) es_log if=$log2es;
```

ä½†å¤šäº§å“æ•´åˆå, éœ€è¦åœ¨ `log_format` åŠ å…¥å¯¹åº”äº§å“, ç”± logstash å†è½åº“
```text
# æ ¹æ®äº§å“, å¢åŠ  log_tag
map $platform $log_tag {
  p1 p1index;
  p2 p2index;
  p3 p3index;
}

# è¿½åŠ  log tag ç»™ logstash åˆ† index
log_format es_log '$remote_addr || $http_host || $request_uri || $http_referer || $http_user_agent || $upstream_response_time || $status || $log_tag';
```
Logstash pipeline:
```yml
# ...
filter {
  # ...
  grok {
    remove_field => ["message"]
    match => { "message" => "%{IP:ip} \|\| %{HOSTNAME:host} \|\| %{URIPATH:requestURI} \|\| %{GREEDYDATA:referer} \|\| %{GREEDYDATA:ua} \|\| %{NUMBER:responseTime} \|\| %{NUMBER:statusCode} \|\| %{WORD:index}" }
  }
  # ...
}
output {
  elasticsearch {
    # ...
    index => "%{[index]}-logs-%{+YYYY-MM}"
    # ...
  }
}
```

### é¢˜å¤–è¯

ä¹‹å‰æ— èŠä¹Ÿç”¨ Go ä¸º [Caddy](https://caddyserver.com/) å®ç°è¿‡ä¸€ä¸ªæ’ä»¶, åŸç†ä¹Ÿæ˜¯å·®ä¸å¤šçš„. æ”¾åœ¨äº† [Github](https://github.com/SakuraHentai/caddy-dynamic-routing) ğŸ‰

-- Fin --

export default ({ children }) => <PostLayout meta={meta}>{children}</PostLayout>
